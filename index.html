<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minecraft Zombie Fighter</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            touch-action: manipulation;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #game-canvas {
            display: block;
            background-color: #111;
            width: 100%;
            height: 100%;
        }
        
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #health-container {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 150px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 5px;
            border: 2px solid #555;
        }
        
        #health-bar {
            height: 15px;
            background-color: #e74c3c;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        #health-text {
            color: white;
            margin-top: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        
        #ammo-container {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid #555;
        }
        
        #score-container {
            position: absolute;
            top: 50px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid #555;
        }
        
        #level-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 8px 16px;
            border-radius: 5px;
            color: #f1c40f;
            font-size: 16px;
            text-align: center;
            border: 2px solid #755;
        }
        
        #level-text {
            font-weight: bold;
        }
        
        #wave-text {
            font-size: 12px;
            margin-top: 3px;
        }
        
        #menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #game-over-screen, #level-complete-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .screen-title {
            font-size: 42px;
            color: #e74c3c;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px #000;
            text-align: center;
        }
        
        .screen-subtitle {
            font-size: 16px;
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
            max-width: 80%;
            line-height: 1.4;
        }
        
        .screen-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 18px;
            margin: 8px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            pointer-events: auto;
            font-weight: bold;
            border: 2px solid #c0392b;
            min-width: 160px;
        }
        
        .screen-button:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }
        
        /* Mobile controls */
        #mobile-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: none;
            gap: 10px;
            z-index: 50;
        }
        
        .mobile-joystick {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
        }
        
        .mobile-btn {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        #shoot-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 70px;
            height: 70px;
            background-color: rgba(231, 76, 60, 0.5);
            display: none;
            font-size: 30px;
            border: 2px solid rgba(255,255,255,0.5);
        }
        
        /* Mobile specific styles */
        @media (max-width: 768px), (orientation: portrait) {
            .screen-title {
                font-size: 32px;
            }
            
            .screen-subtitle {
                font-size: 14px;
            }
            
            .screen-button {
                padding: 10px 20px;
                font-size: 16px;
                min-width: 140px;
            }
            
            #mobile-controls, #shoot-btn {
                display: flex;
            }
            
            #controls-info {
                display: none;
            }
            
            #health-container, #ammo-container, #score-container {
                top: 5px;
                padding: 5px;
                width: 120px;
            }
            
            #health-text, #ammo-container, #score-container {
                font-size: 12px;
            }
            
            #health-bar {
                height: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div id="ui-overlay">
            <div id="health-container">
                <div id="health-bar"></div>
                <div id="health-text">HEALTH: 100%</div>
            </div>
            
            <div id="ammo-container">
                AMMO: <span id="ammo-text">30/120</span>
            </div>
            
            <div id="score-container">
                SCORE: <span id="score-text">0</span>
            </div>
            
            <div id="level-container">
                <div id="level-text">LEVEL 1</div>
                <div id="wave-text">Wave 1 of 5</div>
            </div>
        </div>
        
        <div id="menu-screen">
            <h1 class="screen-title">MINECRAFT ZOMBIE FIGHTER</h1>
            <p class="screen-subtitle">Survive the zombie apocalypse across 20 intense levels. Fight through waves of undead mobs using your diamond bullets!</p>
            <button class="screen-button" id="start-button">START GAME</button>
            <button class="screen-button" id="how-to-play-button">HOW TO PLAY</button>
        </div>
        
        <div id="game-over-screen">
            <h1 class="screen-title">GAME OVER</h1>
            <p class="screen-subtitle" id="game-over-text">You survived until Level 3 with a score of 2,450 points.</p>
            <button class="screen-button" id="restart-button">TRY AGAIN</button>
            <button class="screen-button" id="menu-button">MAIN MENU</button>
        </div>
        
        <div id="level-complete-screen">
            <h1 class="screen-title">LEVEL COMPLETE!</h1>
            <p class="screen-subtitle" id="level-complete-text">You survived Level 1 with 3,200 points. Ready for the next challenge?</p>
            <button class="screen-button" id="next-level-button">NEXT LEVEL</button>
            <button class="screen-button" id="level-menu-button">MAIN MENU</button>
        </div>
        
        <!-- Mobile controls -->
        <div id="mobile-controls">
            <div class="mobile-joystick">
                <div style="grid-column: 2; grid-row: 1;">
                    <div class="mobile-btn" id="move-up">‚Üë</div>
                </div>
                <div style="grid-column: 1; grid-row: 2;">
                    <div class="mobile-btn" id="move-left">‚Üê</div>
                </div>
                <div style="grid-column: 2; grid-row: 2;"></div>
                <div style="grid-column: 3; grid-row: 2;">
                    <div class="mobile-btn" id="move-right">‚Üí</div>
                </div>
                <div style="grid-column: 2; grid-row: 3;">
                    <div class="mobile-btn" id="move-down">‚Üì</div>
                </div>
            </div>
        </div>
        
        <div class="mobile-btn" id="shoot-btn">üíé</div>
    </div>

    <!-- Hidden assets for preloading -->
    <div style="display: none;">
        <img id="player-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/steave.jpg">
        <img id="zombie1-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/zombie.jpg">
        <img id="zombie2-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/enderman.jpg">
        <img id="zombie3-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/creeper.jpg">
        <img id="bullet-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/diamondss.jpg">
        <img id="bg1-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/b4.jpg">
        <img id="bg2-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/b2.jpg">
        <img id="bg3-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/b3.jpg">
        <img id="bg4-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/b4.jpg">
        <img id="bg5-img" src="https://raw.githubusercontent.com/bengeltigerWD/game/main/b5.jpg">
    </div>

    <!-- Audio elements -->
    <audio id="shoot-sound" src="https://github.com/bengeltigerWD/game/raw/main/laser-gun-81720.mp3"></audio>
    <audio id="zombie-hit-sound" src="https://github.com/bengeltigerWD/game/raw/main/game-character-140506.mp3"></audio>
    <audio id="player-hit-sound" src="https://github.com/bengeltigerWD/game/raw/main/cool-hip-hop-loop-275527.mp3"></audio>
    <audio id="level-complete-sound" src="https://github.com/bengeltigerWD/game/raw/main/level-up-47165.mp3"></audio>
    <audio id="game-over-sound" src="https://github.com/bengeltigerWD/game/raw/main/negative_beeps-6008.mp3"></audio>
    <audio id="background-music" loop src="https://github.com/bengeltigerWD/game/raw/main/sfx-short-chop-transient-358667.mp3"></audio>

    <script>
        // Game constants
        const LEVELS = [
            { waves: 5, zombiesPerWave: 5, zombieSpeed: 1.5, zombieHealth: 1 },
            { waves: 5, zombiesPerWave: 8, zombieSpeed: 1.7, zombieHealth: 1 },
            { waves: 6, zombiesPerWave: 10, zombieSpeed: 1.8, zombieHealth: 1 },
            { waves: 6, zombiesPerWave: 12, zombieSpeed: 2.0, zombieHealth: 2 },
            { waves: 7, zombiesPerWave: 12, zombieSpeed: 2.2, zombieHealth: 2 },
            { waves: 7, zombiesPerWave: 15, zombieSpeed: 2.3, zombieHealth: 2 },
            { waves: 8, zombiesPerWave: 15, zombieSpeed: 2.5, zombieHealth: 3 },
            { waves: 8, zombiesPerWave: 18, zombieSpeed: 2.6, zombieHealth: 3 },
            { waves: 9, zombiesPerWave: 18, zombieSpeed: 2.8, zombieHealth: 3 },
            { waves: 10, zombiesPerWave: 20, zombieSpeed: 3.0, zombieHealth: 4 },
            { waves: 10, zombiesPerWave: 22, zombieSpeed: 3.2, zombieHealth: 4, special: "Faster zombies" },
            { waves: 10, zombiesPerWave: 25, zombieSpeed: 3.3, zombieHealth: 5, special: "Tougher zombies" },
            { waves: 11, zombiesPerWave: 25, zombieSpeed: 3.5, zombieHealth: 5, special: "More waves" },
            { waves: 11, zombiesPerWave: 28, zombieSpeed: 3.5, zombieHealth: 6, special: "Zombie swarms" },
            { waves: 12, zombiesPerWave: 30, zombieSpeed: 3.6, zombieHealth: 6, special: "Apocalypse begins" },
            { waves: 12, zombiesPerWave: 32, zombieSpeed: 3.7, zombieHealth: 7, special: "Endless hordes" },
            { waves: 13, zombiesPerWave: 35, zombieSpeed: 3.8, zombieHealth: 7, special: "Nightmare mode" },
            { waves: 13, zombiesPerWave: 38, zombieSpeed: 4.0, zombieHealth: 8, special: "Final onslaught" },
            { waves: 14, zombiesPerWave: 40, zombieSpeed: 4.2, zombieHealth: 8, special: "Hell on earth" },
            { waves: 15, zombiesPerWave: 50, zombieSpeed: 4.5, zombieHealth: 10, special: "BOSS WAVE" }
        ];

        // Game variables
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const healthBar = document.getElementById('health-bar');
        const healthText = document.getElementById('health-text');
        const ammoText = document.getElementById('ammo-text');
        const scoreText = document.getElementById('score-text');
        const levelText = document.getElementById('level-text');
        const waveText = document.getElementById('wave-text');
        const levelContainer = document.getElementById('level-container');
        
        // UI screens
        const menuScreen = document.getElementById('menu-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const levelCompleteScreen = document.getElementById('level-complete-screen');
        const gameOverText = document.getElementById('game-over-text');
        const levelCompleteText = document.getElementById('level-complete-text');
        
        // Buttons
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const menuButton = document.getElementById('menu-button');
        const nextLevelButton = document.getElementById('next-level-button');
        const levelMenuButton = document.getElementById('level-menu-button');
        
        // Audio elements
        const shootSound = document.getElementById('shoot-sound');
        const zombieHitSound = document.getElementById('zombie-hit-sound');
        const playerHitSound = document.getElementById('player-hit-sound');
        const levelCompleteSound = document.getElementById('level-complete-sound');
        const gameOverSound = document.getElementById('game-over-sound');
        const backgroundMusic = document.getElementById('background-music');
        
        // Game state
        let gameRunning = false;
        let currentLevel = 0;
        let currentWave = 0;
        let zombiesAlive = 0;
        let zombiesKilled = 0;
        let score = 0;
        let gameTime = 0;
        let mobileShootInterval;
        
        // Player object
        const player = {
            x: 0,
            y: 0,
            width: 40,
            height: 40,
            speed: 5,
            health: 100,
            maxHealth: 100,
            ammo: 30,
            maxAmmo: 120,
            reloading: false,
            lastShot: 0,
            shootDelay: 200,
            damage: 10,
            direction: { x: 0, y: 1 },
            img: document.getElementById('player-img')
        };
        
        // Game objects
        let bullets = [];
        let zombies = [];
        let powerups = [];
        let explosions = [];
        
        // Background
        let backgroundImages = [
            document.getElementById('bg1-img'),
            document.getElementById('bg2-img'),
            document.getElementById('bg3-img'),
            document.getElementById('bg4-img'),
            document.getElementById('bg5-img')
        ];
        let currentBackground = 0;
        
        // Mobile control variables
        const mobileControls = {
            up: false,
            down: false,
            left: false,
            right: false
        };
        
        // Initialize game with mobile detection
        function initGame() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                player.speed = 4;
                player.shootDelay = 300;
                setupMobileControls();
            }
            
            currentLevel = 0;
            score = 0;
            startLevel();
        }
        
        // Setup mobile touch controls
        function setupMobileControls() {
            document.getElementById('move-up').addEventListener('touchstart', () => mobileControls.up = true);
            document.getElementById('move-up').addEventListener('touchend', () => mobileControls.up = false);
            
            document.getElementById('move-down').addEventListener('touchstart', () => mobileControls.down = true);
            document.getElementById('move-down').addEventListener('touchend', () => mobileControls.down = false);
            
            document.getElementById('move-left').addEventListener('touchstart', () => mobileControls.left = true);
            document.getElementById('move-left').addEventListener('touchend', () => mobileControls.left = false);
            
            document.getElementById('move-right').addEventListener('touchstart', () => mobileControls.right = true);
            document.getElementById('move-right').addEventListener('touchend', () => mobileControls.right = false);
            
            const shootBtn = document.getElementById('shoot-btn');
            shootBtn.addEventListener('touchstart', () => {
                if (gameRunning) {
                    shoot();
                    mobileShootInterval = setInterval(shoot, player.shootDelay);
                }
            });
            
            shootBtn.addEventListener('touchend', () => {
                clearInterval(mobileShootInterval);
            });
        }
        
        // Start a new level
        function startLevel() {
            currentWave = 0;
            zombiesAlive = 0;
            zombiesKilled = 0;
            gameTime = 0;
            
            player.health = player.maxHealth;
            player.ammo = player.maxAmmo / 2;
            player.reloading = false;
            
            bullets = [];
            zombies = [];
            powerups = [];
            explosions = [];
            
            updateHealthUI();
            updateAmmoUI();
            updateScoreUI();
            updateLevelUI();
            
            currentBackground = Math.floor(Math.random() * backgroundImages.length);
            
            menuScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            levelCompleteScreen.style.display = 'none';
            gameRunning = true;
            
            startNextWave();
            
            backgroundMusic.volume = 0.3;
            backgroundMusic.play().catch(e => console.log("Audio play failed:", e));
            
            requestAnimationFrame(gameLoop);
        }
        
        // Start the next wave of zombies
        function startNextWave() {
            currentWave++;
            
            if (currentWave > LEVELS[currentLevel].waves) {
                completeLevel();
                return;
            }
            
            updateLevelUI();
            
            levelContainer.style.display = 'block';
            setTimeout(() => {
                levelContainer.style.display = 'none';
            }, 2000);
            
            const zombiesToSpawn = LEVELS[currentLevel].zombiesPerWave + Math.floor(currentWave / 2);
            zombiesAlive += zombiesToSpawn;
            
            for (let i = 0; i < zombiesToSpawn; i++) {
                spawnZombie();
            }
        }
        
        // Spawn a new zombie
        function spawnZombie() {
            const edge = Math.floor(Math.random() * 4);
            let x, y;
            
            switch (edge) {
                case 0: x = Math.random() * canvas.width; y = -50; break;
                case 1: x = canvas.width + 50; y = Math.random() * canvas.height; break;
                case 2: x = Math.random() * canvas.width; y = canvas.height + 50; break;
                case 3: x = -50; y = Math.random() * canvas.height; break;
            }
            
            const zombieTypes = ['zombie1-img', 'zombie2-img', 'zombie3-img'];
            const zombieType = zombieTypes[Math.floor(Math.random() * zombieTypes.length)];
            
            zombies.push({
                x: x,
                y: y,
                width: 40,
                height: 40,
                speed: LEVELS[currentLevel].zombieSpeed,
                health: LEVELS[currentLevel].zombieHealth,
                maxHealth: LEVELS[currentLevel].zombieHealth,
                damage: 10,
                img: document.getElementById(zombieType),
                type: zombieType
            });
        }
        
        // Complete the current level
        function completeLevel() {
            gameRunning = false;
            
            const timeBonus = Math.max(0, 5000 - Math.floor(gameTime / 1000) * 100);
            const healthBonus = Math.floor(player.health / player.maxHealth * 2000);
            const waveBonus = currentWave * 500;
            const totalBonus = timeBonus + healthBonus + waveBonus;
            
            score += totalBonus;
            updateScoreUI();
            
            levelCompleteText.textContent = `You survived Level ${currentLevel + 1} with ${score} points. ${totalBonus > 0 ? `+${totalBonus} bonus points!` : ''}`;
            levelCompleteScreen.style.display = 'flex';
            
            levelCompleteSound.play().catch(e => console.log("Audio play failed:", e));
            backgroundMusic.pause();
        }
        
        // Start the next level
        function nextLevel() {
            currentLevel++;
            
            if (currentLevel >= LEVELS.length) {
                gameComplete();
                return;
            }
            
            startLevel();
        }
        
        // Game is fully complete
        function gameComplete() {
            gameOverText.textContent = `CONGRATULATIONS! You completed all ${LEVELS.length} levels with ${score} points!`;
            gameOverScreen.style.display = 'flex';
        }
        
        // Game over
        function gameOver() {
            gameRunning = false;
            
            gameOverText.textContent = `You survived until Level ${currentLevel + 1} with a score of ${score} points.`;
            gameOverScreen.style.display = 'flex';
            
            gameOverSound.play().catch(e => console.log("Audio play failed:", e));
            backgroundMusic.pause();
        }
        
        // Update health UI
        function updateHealthUI() {
            const healthPercent = (player.health / player.maxHealth) * 100;
            healthBar.style.width = `${healthPercent}%`;
            healthText.textContent = `HEALTH: ${Math.floor(healthPercent)}%`;
            
            if (healthPercent > 60) {
                healthBar.style.backgroundColor = '#2ecc71';
            } else if (healthPercent > 30) {
                healthBar.style.backgroundColor = '#f39c12';
            } else {
                healthBar.style.backgroundColor = '#e74c3c';
            }
        }
        
        // Update ammo UI
        function updateAmmoUI() {
            ammoText.textContent = `${player.ammo}/${player.maxAmmo}`;
            
            if (player.ammo < 10) {
                ammoText.style.color = '#e74c3c';
            } else {
                ammoText.style.color = '#fff';
            }
        }
        
        // Update score UI
        function updateScoreUI() {
            scoreText.textContent = score.toLocaleString();
        }
        
        // Update level UI
        function updateLevelUI() {
            levelText.textContent = `LEVEL ${currentLevel + 1}`;
            waveText.textContent = `Wave ${currentWave} of ${LEVELS[currentLevel].waves}`;
        }
        
        // Game loop
        function gameLoop(timestamp) {
            if (!gameRunning) return;
            
            const deltaTime = timestamp - gameTime;
            gameTime = timestamp;
            
            update(deltaTime);
            draw();
            
            requestAnimationFrame(gameLoop);
        }
        
        // Update game state
        function update(deltaTime) {
            updatePlayerPosition();
            updateBullets();
            updateZombies();
            updateExplosions();
            checkCollisions();
            
            if (zombiesAlive <= 0 && zombies.length <= 0) {
                startNextWave();
            }
        }
        
        // Update player position
        function updatePlayerPosition() {
            if (keys.KeyW || keys.ArrowUp || mobileControls.up) player.y -= player.speed;
            if (keys.KeyS || keys.ArrowDown || mobileControls.down) player.y += player.speed;
            if (keys.KeyA || keys.ArrowLeft || mobileControls.left) player.x -= player.speed;
            if (keys.KeyD || keys.ArrowRight || mobileControls.right) player.x += player.speed;
            
            player.x = Math.max(player.width / 2, Math.min(canvas.width - player.width / 2, player.x));
            player.y = Math.max(player.height / 2, Math.min(canvas.height - player.height / 2, player.y));
            
            if (mouse.x !== null && mouse.y !== null) {
                player.direction = {
                    x: mouse.x - player.x,
                    y: mouse.y - player.y
                };
                
                const length = Math.sqrt(player.direction.x * player.direction.x + player.direction.y * player.direction.y);
                if (length > 0) {
                    player.direction.x /= length;
                    player.direction.y /= length;
                }
            }
        }
        
        // Update bullets
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.dx * bullet.speed;
                bullet.y += bullet.dy * bullet.speed;
                
                if (bullet.x < 0 || bullet.x > canvas.width || 
                    bullet.y < 0 || bullet.y > canvas.height) {
                    bullets.splice(i, 1);
                }
            }
        }
        
        // Update zombies
        function updateZombies() {
            for (let i = zombies.length - 1; i >= 0; i--) {
                const zombie = zombies[i];
                const dx = player.x - zombie.x;
                const dy = player.y - zombie.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 0) {
                    zombie.x += (dx / distance) * zombie.speed;
                    zombie.y += (dy / distance) * zombie.speed;
                }
                
                if (distance < 30) {
                    player.health -= zombie.damage * 0.1;
                    updateHealthUI();
                    
                    if (player.health <= 0) {
                        player.health = 0;
                        updateHealthUI();
                        gameOver();
                        return;
                    }
                }
            }
        }
        
        // Update explosions
        function updateExplosions() {
            for (let i = explosions.length - 1; i >= 0; i--) {
                explosions[i].time--;
                if (explosions[i].time <= 0) {
                    explosions.splice(i, 1);
                }
            }
        }
        
        // Check for collisions
        function checkCollisions() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                
                for (let j = zombies.length - 1; j >= 0; j--) {
                    const zombie = zombies[j];
                    const dx = bullet.x - zombie.x;
                    const dy = bullet.y - zombie.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 20) {
                        zombie.health -= bullet.damage;
                        
                        explosions.push({
                            x: zombie.x,
                            y: zombie.y,
                            size: 30,
                            time: 10
                        });
                        
                        zombieHitSound.currentTime = 0;
                        zombieHitSound.play().catch(e => console.log("Audio play failed:", e));
                        
                        bullets.splice(i, 1);
                        
                        if (zombie.health <= 0) {
                            zombies.splice(j, 1);
                            zombiesAlive--;
                            zombiesKilled++;
                            
                            score += 100;
                            updateScoreUI();
                            
                            if (Math.random() < 0.2) {
                                powerups.push({
                                    x: zombie.x,
                                    y: zombie.y,
                                    type: 'ammo',
                                    amount: 10,
                                    img: document.getElementById('bullet-img')
                                });
                            }
                        }
                        
                        break;
                    }
                }
            }
            
            for (let i = powerups.length - 1; i >= 0; i--) {
                const powerup = powerups[i];
                const dx = player.x - powerup.x;
                const dy = player.y - powerup.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 30) {
                    if (powerup.type === 'ammo') {
                        player.ammo = Math.min(player.maxAmmo, player.ammo + powerup.amount);
                        updateAmmoUI();
                    }
                    
                    powerups.splice(i, 1);
                }
            }
        }
        
        // Draw everything
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (backgroundImages[currentBackground].complete) {
                ctx.drawImage(backgroundImages[currentBackground], 0, 0, canvas.width, canvas.height);
            }
            
            for (const powerup of powerups) {
                if (powerup.img.complete) {
                    ctx.save();
                    ctx.globalAlpha = 0.8;
                    ctx.drawImage(powerup.img, powerup.x - 15, powerup.y - 15, 30, 30);
                    ctx.restore();
                }
            }
            
            for (const zombie of zombies) {
                if (zombie.img.complete) {
                    const angle = Math.atan2(player.y - zombie.y, player.x - zombie.x);
                    
                    ctx.save();
                    ctx.translate(zombie.x, zombie.y);
                    ctx.rotate(angle);
                    
                    ctx.drawImage(zombie.img, -zombie.width / 2, -zombie.height / 2, zombie.width, zombie.height);
                    
                    if (zombie.health < zombie.maxHealth) {
                        const healthWidth = 30;
                        const healthHeight = 5;
                        const healthPercent = zombie.health / zombie.maxHealth;
                        
                        ctx.fillStyle = '#333';
                        ctx.fillRect(-healthWidth / 2, -zombie.height / 2 - 10, healthWidth, healthHeight);
                        
                        ctx.fillStyle = healthPercent > 0.5 ? '#2ecc71' : healthPercent > 0.2 ? '#f39c12' : '#e74c3c';
                        ctx.fillRect(-healthWidth / 2, -zombie.height / 2 - 10, healthWidth * healthPercent, healthHeight);
                    }
                    
                    ctx.restore();
                }
            }
            
            for (const bullet of bullets) {
                if (bullet.img.complete) {
                    ctx.drawImage(bullet.img, bullet.x - bullet.radius, bullet.y - bullet.radius, bullet.radius * 2, bullet.radius * 2);
                }
            }
            
            for (const explosion of explosions) {
                const size = explosion.size * (explosion.time / 10);
                ctx.fillStyle = `rgba(255, ${Math.floor(100 + explosion.time * 15)}, 0, ${explosion.time / 10})`;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            if (player.img.complete) {
                const angle = Math.atan2(player.direction.y, player.direction.x);
                
                ctx.save();
                ctx.translate(player.x, player.y);
                ctx.rotate(angle);
                
                ctx.drawImage(player.img, -player.width / 2, -player.height / 2, player.width, player.height);
                ctx.restore();
            }
        }
        
        // Input handling
        const keys = {
            KeyW: false,
            KeyA: false,
            KeyS: false,
            KeyD: false,
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false,
            KeyR: false
        };
        
        const mouse = {
            x: null,
            y: null,
            clicked: false
        };
        
        // Keyboard events
        window.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.code)) {
                keys[e.code] = true;
            }
            
            if (e.code === 'KeyR' && gameRunning && !player.reloading && player.ammo < player.maxAmmo) {
                player.reloading = true;
                setTimeout(() => {
                    player.ammo = player.maxAmmo;
                    updateAmmoUI();
                    player.reloading = false;
                }, 1000);
            }
        });
        
        window.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.code)) {
                keys[e.code] = false;
            }
        });
        
        // Mouse events
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        });
        
        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 0) {
                mouse.clicked = true;
                shoot();
            }
        });
        
        canvas.addEventListener('mouseup', (e) => {
            if (e.button === 0) {
                mouse.clicked = false;
            }
        });
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            mouse.x = touch.clientX - rect.left;
            mouse.y = touch.clientY - rect.top;
            mouse.clicked = true;
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            mouse.x = touch.clientX - rect.left;
            mouse.y = touch.clientY - rect.top;
        });
        
        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            mouse.clicked = false;
        });
        
        // Shoot a bullet
        function shoot() {
            if (!gameRunning || player.reloading || player.ammo <= 0) return;
            
            const now = Date.now();
            if (now - player.lastShot < player.shootDelay) return;
            
            player.lastShot = now;
            player.ammo--;
            updateAmmoUI();
            
            shootSound.currentTime = 0;
            shootSound.play().catch(e => console.log("Audio play failed:", e));
            
            bullets.push({
                x: player.x,
                y: player.y,
                dx: player.direction.x,
                dy: player.direction.y,
                speed: 10,
                radius: 5,
                damage: player.damage,
                img: document.getElementById('bullet-img')
            });
            
            if (player.ammo <= 0) {
                player.reloading = true;
                setTimeout(() => {
                    player.ammo = player.maxAmmo;
                    updateAmmoUI();
                    player.reloading = false;
                }, 1000);
            }
        }
        
        // Button event listeners
        startButton.addEventListener('click', initGame);
        restartButton.addEventListener('click', initGame);
        menuButton.addEventListener('click', () => {
            gameOverScreen.style.display = 'none';
            menuScreen.style.display = 'flex';
        });
        nextLevelButton.addEventListener('click', nextLevel);
        levelMenuButton.addEventListener('click', () => {
            levelCompleteScreen.style.display = 'none';
            menuScreen.style.display = 'flex';
        });
        
        // Initialize canvas size
        function resizeCanvas() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                const size = Math.min(window.innerWidth, window.innerHeight, 800);
                canvas.width = size;
                canvas.height = size;
            } else {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
        }
        
        // Preload assets
        function preloadAssets() {
            const assets = [
                document.getElementById('player-img'),
                document.getElementById('zombie1-img'),
                document.getElementById('zombie2-img'),
                document.getElementById('zombie3-img'),
                document.getElementById('bullet-img'),
                document.getElementById('bg1-img'),
                document.getElementById('bg2-img'),
                document.getElementById('bg3-img'),
                document.getElementById('bg4-img'),
                document.getElementById('bg5-img')
            ];
            
            assets.forEach(img => {
                if (!img.complete) {
                    img.onload = () => console.log('Image loaded:', img.id);
                    img.onerror = () => console.log('Error loading image:', img.id);
                }
            });
            
            const sounds = [
                shootSound, zombieHitSound, playerHitSound, 
                levelCompleteSound, gameOverSound, backgroundMusic
            ];
            
            sounds.forEach(sound => {
                sound.load().catch(e => console.log('Error loading sound:', e));
            });
        }
        
        // Initialize game
        window.addEventListener('load', () => {
            resizeCanvas();
            preloadAssets();
        });
        
        window.addEventListener('resize', resizeCanvas);
    </script>
</body>
</html>
